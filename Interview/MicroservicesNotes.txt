===================================================================================
                    ğŸ”— MICROSERVICES ARCHITECTURE - COMPLETE GUIDE
===================================================================================

                        For Smart Stay Project
                        Express â†” FastAPI Communication

===================================================================================
                         CHAPTER 1: WHAT ARE MICROSERVICES?
===================================================================================

DEFINITION:
-----------
Microservices is an architectural style where an application is built
as a collection of small, independent services that communicate over
a network.

MONOLITH VS MICROSERVICES:
-------------------------

MONOLITH:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           ONE BIG APP           â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”       â”‚
    â”‚  â”‚Usersâ”‚ â”‚Hotelâ”‚ â”‚ AI  â”‚       â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜       â”‚
    â”‚         ONE DATABASE            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MICROSERVICES:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Users   â”‚ â†â†’  â”‚  Hotels  â”‚ â†â†’  â”‚    AI    â”‚
    â”‚ Service  â”‚     â”‚ Service  â”‚     â”‚ Service  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                â†“                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  User DB â”‚     â”‚ Hotel DB â”‚     â”‚  AI DB   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


BENEFITS:
--------
1. Technology Freedom: Use best language/framework for each service
2. Independent Scaling: Scale only what needs scaling
3. Fault Isolation: One service failure doesn't crash everything
4. Team Independence: Teams can work on services independently
5. Easier Maintenance: Smaller codebases are easier to understand

CHALLENGES:
----------
1. Network Complexity: Services need to communicate
2. Data Consistency: No single database
3. Debugging: Harder to trace issues across services
4. Deployment: More things to deploy

===================================================================================
                         CHAPTER 2: SMART STAY ARCHITECTURE
===================================================================================

ARCHITECTURE DIAGRAM:
--------------------

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         BROWSER                                  â”‚
    â”‚                     (User Interface)                             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â†“ HTTP (Port 8080)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   EXPRESS.JS SERVICE                             â”‚
    â”‚                     (Node.js - Port 8080)                        â”‚
    â”‚                                                                  â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚   â”‚ Hotel CRUD  â”‚  â”‚  EJS Views  â”‚  â”‚  AI Route Proxy     â”‚    â”‚
    â”‚   â”‚   Routes    â”‚  â”‚  Rendering  â”‚  â”‚  (calls FastAPI)    â”‚    â”‚
    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”‚                                                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â†“                       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      MONGODB          â”‚   â”‚        FASTAPI SERVICE            â”‚
    â”‚  (Database - 27017)   â”‚   â”‚      (Python - Port 8000)         â”‚
    â”‚                       â”‚   â”‚                                    â”‚
    â”‚  - Hotel Listings     â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  - AI Checkpoints     â”‚   â”‚  â”‚LangGraph â”‚  â”‚   OpenAI      â”‚  â”‚
    â”‚                       â”‚   â”‚  â”‚Workflows â”‚  â”‚   GPT-4       â”‚  â”‚
    â”‚                       â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                       â”‚   â”‚                                    â”‚
    â”‚                       â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚                       â”‚   â”‚  â”‚  Tavily  â”‚  â”‚   Weather     â”‚  â”‚
    â”‚                       â”‚   â”‚  â”‚  Search  â”‚  â”‚     API       â”‚  â”‚
    â”‚                       â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


WHY THIS ARCHITECTURE?
---------------------

1. Express for Web Layer:
   - Excellent EJS templating
   - Great for serving HTML
   - Easy routing
   - Huge middleware ecosystem
   
2. FastAPI for AI Layer:
   - Python has best AI libraries
   - LangGraph is Python-only
   - OpenAI SDK more mature in Python
   - Better for CPU-intensive AI tasks

3. MongoDB for Both:
   - Shared database for listings
   - AI checkpoints for HITL
   - Flexible schema

===================================================================================
                         CHAPTER 3: SERVICE COMMUNICATION
===================================================================================

HOW SERVICES TALK:
-----------------
Services communicate via HTTP/REST APIs.
Express makes HTTP requests to FastAPI.

REQUEST FLOW:
------------
1. User clicks "Plan Trip" in browser
2. Browser sends POST to Express (8080)
3. Express receives request in routes/ai.js
4. Express makes HTTP POST to FastAPI (8000)
5. FastAPI runs LangGraph workflow
6. FastAPI returns JSON to Express
7. Express sends response to browser
8. Browser displays result

CODE EXAMPLE - EXPRESS SIDE:
---------------------------
    // routes/ai.js
    const AI_SERVICE_URL = "http://localhost:8000";
    
    router.post("/travel/plan", async (req, res) => {
        try {
            // Make HTTP request to FastAPI
            const response = await fetch(`${AI_SERVICE_URL}/agent/travel-planner`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    query: req.body.query,
                    source: req.body.source,
                    destination: req.body.destination
                })
            });
            
            // Check if FastAPI responded OK
            if (!response.ok) {
                throw new Error(`FastAPI error: ${response.status}`);
            }
            
            // Parse JSON response
            const data = await response.json();
            
            // Send to browser
            res.json(data);
            
        } catch (error) {
            // Handle errors
            res.status(500).json({
                error: "AI service unavailable",
                detail: error.message
            });
        }
    });


CODE EXAMPLE - FASTAPI SIDE:
---------------------------
    # agent_service.py
    from fastapi import APIRouter
    from pydantic import BaseModel
    
    router = APIRouter(prefix="/agent")
    
    class TravelRequest(BaseModel):
        query: str
        source: str = None
        destination: str = None
    
    @router.post("/travel-planner")
    async def plan_travel(request: TravelRequest):
        # Run LangGraph workflow
        result = travel_graph.invoke({
            "query": request.query,
            "source": request.source,
            "destination": request.destination
        })
        return result

===================================================================================
                         CHAPTER 4: ERROR HANDLING
===================================================================================

ERRORS CAN HAPPEN AT:
--------------------
1. Browser â†’ Express (network error)
2. Express â†’ FastAPI (service down)
3. FastAPI â†’ OpenAI (API rate limit)
4. FastAPI â†’ MongoDB (connection lost)

LAYERED ERROR HANDLING:
----------------------

LAYER 1 - FastAPI (innermost):
    @router.post("/travel-planner")
    async def plan_travel(request: TravelRequest):
        try:
            result = travel_graph.invoke(...)
            return result
        except openai.RateLimitError:
            raise HTTPException(429, "AI rate limited")
        except Exception as e:
            raise HTTPException(500, f"AI error: {str(e)}")

LAYER 2 - Express (middle):
    router.post("/travel/plan", async (req, res) => {
        try {
            const response = await fetch(...);
            
            if (!response.ok) {
                // FastAPI returned error
                const error = await response.json();
                return res.status(response.status).json(error);
            }
            
            const data = await response.json();
            res.json(data);
            
        } catch (error) {
            // Network error - FastAPI unreachable
            res.status(503).json({
                error: "AI service unavailable",
                detail: "Please ensure AI service is running"
            });
        }
    });

LAYER 3 - Frontend (outermost):
    async function planTrip(query) {
        try {
            const response = await fetch('/api/travel/plan', {
                method: 'POST',
                body: JSON.stringify({ query })
            });
            
            if (!response.ok) {
                const error = await response.json();
                showError(error.detail || "Something went wrong");
                return;
            }
            
            const data = await response.json();
            displayResults(data);
            
        } catch (error) {
            showError("Network error. Please check your connection.");
        }
    }

===================================================================================
                         CHAPTER 5: HEALTH CHECKS
===================================================================================

WHY HEALTH CHECKS?
-----------------
Quickly verify if services are running.
Useful for debugging and monitoring.

IMPLEMENTING:
------------

FastAPI health check:
    @app.get("/health")
    def health_check():
        return {
            "status": "healthy",
            "service": "AI Service",
            "timestamp": datetime.now().isoformat()
        }

Express health check:
    app.get("/health", (req, res) => {
        res.json({
            status: "healthy",
            service: "Main Server",
            timestamp: new Date().toISOString()
        });
    });

Full system check:
    app.get("/health/full", async (req, res) => {
        const results = {
            express: "healthy",
            fastapi: "unknown",
            mongodb: "unknown"
        };
        
        // Check FastAPI
        try {
            const response = await fetch("http://localhost:8000/health");
            results.fastapi = response.ok ? "healthy" : "unhealthy";
        } catch {
            results.fastapi = "unreachable";
        }
        
        // Check MongoDB
        try {
            await mongoose.connection.db.admin().ping();
            results.mongodb = "healthy";
        } catch {
            results.mongodb = "unreachable";
        }
        
        res.json(results);
    });

===================================================================================
                         CHAPTER 6: SERVICE DISCOVERY
===================================================================================

HARDCODED VS DYNAMIC:
--------------------

Hardcoded (current - fine for development):
    const AI_SERVICE_URL = "http://localhost:8000";

Environment variables (better):
    const AI_SERVICE_URL = process.env.AI_SERVICE_URL || "http://localhost:8000";

Service registry (production):
    - Services register themselves
    - Clients lookup service addresses
    - Examples: Consul, Kubernetes Service Discovery


ENVIRONMENT VARIABLES:
---------------------

Express (.env):
    AI_SERVICE_URL=http://localhost:8000
    MONGO_URL=mongodb://127.0.0.1:27017/smartstay
    PORT=8080

FastAPI (.env):
    OPENAI_API_KEY=sk-...
    TAVILY_API_KEY=tvly-...
    MONGO_URL=mongodb://127.0.0.1:27017/smartstay
    PORT=8000

===================================================================================
                         CHAPTER 7: DATA FLOW EXAMPLES
===================================================================================

EXAMPLE 1: Travel Planner
-------------------------

    Browser                Express              FastAPI              OpenAI
       â”‚                     â”‚                     â”‚                    â”‚
       â”‚  POST /api/travel   â”‚                     â”‚                    â”‚
       â”‚  {query: "Goa"}     â”‚                     â”‚                    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                     â”‚                    â”‚
       â”‚                     â”‚  POST /agent/       â”‚                    â”‚
       â”‚                     â”‚  travel-planner     â”‚                    â”‚
       â”‚                     â”‚  {query: "Goa"}     â”‚                    â”‚
       â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚
       â”‚                     â”‚                     â”‚  GPT-4 calls       â”‚
       â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
       â”‚                     â”‚                     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                     â”‚                     â”‚                    â”‚
       â”‚                     â”‚  {status: "ok",     â”‚                    â”‚
       â”‚                     â”‚   packages: [...]}  â”‚                    â”‚
       â”‚                     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚  {status: "ok",     â”‚                     â”‚                    â”‚
       â”‚   packages: [...]}  â”‚                     â”‚                    â”‚
       â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                    â”‚


EXAMPLE 2: Solo Trip with HITL
------------------------------

    Browser                Express              FastAPI              MongoDB
       â”‚                     â”‚                     â”‚                    â”‚
       â”‚  POST /api/solo     â”‚                     â”‚                    â”‚
       â”‚  {query: "Manali"}  â”‚                     â”‚                    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                     â”‚                    â”‚
       â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚
       â”‚                     â”‚                     â”‚  Save checkpoint   â”‚
       â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
       â”‚                     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚  {status: "waiting",â”‚                     â”‚                    â”‚
       â”‚   question: "..."}  â”‚                     â”‚                    â”‚
       â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                    â”‚
       â”‚                     â”‚                     â”‚                    â”‚
       â”‚  POST /api/solo     â”‚                     â”‚                    â”‚
       â”‚  {answer: "car",    â”‚                     â”‚                    â”‚
       â”‚   thread_id: "123"} â”‚                     â”‚                    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                     â”‚                    â”‚
       â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                    â”‚
       â”‚                     â”‚                     â”‚  Load checkpoint   â”‚
       â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
       â”‚                     â”‚                     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                     â”‚                     â”‚  Resume workflow   â”‚
       â”‚                     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
       â”‚  {status: "waiting",â”‚                     â”‚                    â”‚
       â”‚   question: "..."}  â”‚  (next question)    â”‚                    â”‚
       â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                    â”‚

===================================================================================
                         CHAPTER 8: INTERVIEW ANSWERS
===================================================================================

Q: Why microservices instead of monolith?
A: "I used microservices because the AI features needed Python
    (LangGraph, OpenAI) while the web layer worked better with
    Node.js (Express, EJS). Microservices let me use the best
    tool for each job while keeping services independent."

Q: How do the services communicate?
A: "Services communicate via HTTP/REST. When a user requests
    AI features, Express makes an HTTP POST to FastAPI with JSON
    payload. FastAPI processes it through LangGraph and returns
    JSON response. Express then sends this to the browser."

Q: What happens if FastAPI is down?
A: "I have layered error handling. If FastAPI is unreachable,
    Express catches the network error and returns a 503 Service
    Unavailable with a friendly message. The hotel CRUD features
    still work - only AI features are affected."

Q: How would you scale this in production?
A: "I'd containerize services with Docker, use Kubernetes for
    orchestration, add a load balancer, use environment variables
    for service URLs, and implement health checks for monitoring.
    Services could scale independently based on demand."

Q: Why not just use Python for everything?
A: "Express/Node.js is better for serving web pages, has mature
    templating (EJS), and handles concurrent connections well.
    Python/FastAPI is better for AI workloads. By separating them,
    I can optimize each service for its specific task."

===================================================================================
                              KEY TAKEAWAYS
===================================================================================

1. Microservices = Multiple independent services communicating over network
2. Smart Stay uses Express (web) + FastAPI (AI) architecture
3. Services communicate via HTTP/REST with JSON payloads
4. Error handling at each layer (FastAPI â†’ Express â†’ Frontend)
5. Health checks for monitoring service status
6. Environment variables for configuration

REMEMBER: Microservices add complexity but provide flexibility.
          Use when benefits outweigh the operational overhead.

===================================================================================

