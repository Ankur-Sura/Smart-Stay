===================================================================================
                    ðŸ·ï¸ NLP AMENITY EXTRACTION - STUDY NOTES
===================================================================================

                        For Smart Stay Project
                        GPT-4 Function Calling Feature

===================================================================================
                         WHAT IS THIS FEATURE?
===================================================================================

PROBLEM:
-------
Hotels have descriptions like:
    "Beautiful beachfront property with infinity pool, 
    complimentary WiFi, free parking, and 24-hour room service..."

We need structured data for search:
    amenities: ["Pool", "WiFi", "Parking", "Room Service"]

MANUAL APPROACH (Bad):
    - Read every description
    - Manually tag amenities
    - Time-consuming for 100+ hotels
    - Inconsistent tagging

AI APPROACH (Good):
    - Send description to GPT-4
    - GPT-4 extracts amenities automatically
    - Consistent, fast, scalable

===================================================================================
                         HOW IT WORKS
===================================================================================

TECHNOLOGY: GPT-4 Function Calling (now called "Tools")

CONCEPT:
-------
Instead of asking GPT-4 for text response, we ask it to call a function
with structured arguments.

NORMAL GPT-4 CALL:
    User: "What amenities does this hotel have? 'Pool, WiFi, AC...'"
    GPT-4: "This hotel has a pool, WiFi, and air conditioning."
    
    Problem: Text response - hard to parse!

FUNCTION CALLING:
    User: "Extract amenities from: 'Pool, WiFi, AC...'"
    GPT-4: {"name": "extract_amenities", "arguments": {"amenities": ["Pool", "WiFi", "AC"]}}
    
    Solution: Structured JSON - easy to use!

===================================================================================
                         IMPLEMENTATION
===================================================================================

STEP 1: DEFINE THE FUNCTION SCHEMA
---------------------------------

functions = [
    {
        "name": "extract_amenities",
        "description": "Extract hotel amenities from a description",
        "parameters": {
            "type": "object",
            "properties": {
                "amenities": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "List of amenities found in the description"
                }
            },
            "required": ["amenities"]
        }
    }
]

WHAT THIS TELLS GPT-4:
- Function name: extract_amenities
- It should return: an array of strings
- The array contains: amenities found in text


STEP 2: CALL GPT-4 WITH FUNCTION
-------------------------------

from openai import OpenAI

client = OpenAI()

def extract_amenities(description: str) -> list:
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {
                "role": "system",
                "content": "Extract amenities from hotel descriptions."
            },
            {
                "role": "user", 
                "content": f"Extract amenities from: {description}"
            }
        ],
        functions=functions,
        function_call={"name": "extract_amenities"}  # Force this function
    )
    
    # Parse the function call
    function_args = json.loads(
        response.choices[0].message.function_call.arguments
    )
    
    return function_args["amenities"]


STEP 3: USE IN API ENDPOINT
--------------------------

@router.post("/listings/{listing_id}/extract-amenities")
async def extract_listing_amenities(listing_id: str):
    # Get listing from MongoDB
    listing = await Listing.find_by_id(listing_id)
    
    # Extract amenities using GPT-4
    amenities = extract_amenities(listing.description)
    
    # Update listing with amenities
    listing.amenities = amenities
    await listing.save()
    
    return {"amenities": amenities}

===================================================================================
                         EXAMPLE
===================================================================================

INPUT (Hotel Description):
-------------------------
"Luxurious 5-star resort featuring an infinity pool overlooking the ocean,
state-of-the-art fitness center, spa services, complimentary high-speed WiFi,
free valet parking, three on-site restaurants including rooftop dining,
24-hour concierge service, and private beach access."

GPT-4 FUNCTION CALL:
-------------------
{
    "name": "extract_amenities",
    "arguments": {
        "amenities": [
            "Infinity Pool",
            "Fitness Center",
            "Spa",
            "WiFi",
            "Valet Parking",
            "Restaurant",
            "Rooftop Dining",
            "Concierge Service",
            "Beach Access"
        ]
    }
}

OUTPUT (Stored in MongoDB):
--------------------------
{
    "_id": "...",
    "title": "Ocean View Resort",
    "description": "Luxurious 5-star resort...",
    "amenities": [
        "Infinity Pool",
        "Fitness Center",
        "Spa",
        "WiFi",
        "Valet Parking",
        "Restaurant",
        "Rooftop Dining",
        "Concierge Service",
        "Beach Access"
    ]
}

===================================================================================
                         BULK EXTRACTION
===================================================================================

PROCESS ALL HOTELS:
------------------

async def extract_all_amenities():
    """Extract amenities for all listings without amenities"""
    
    # Find listings without amenities
    listings = await Listing.find({"amenities": {"$size": 0}})
    
    for listing in listings:
        if listing.description:
            # Extract amenities
            amenities = extract_amenities(listing.description)
            
            # Update listing
            listing.amenities = amenities
            await listing.save()
            
            print(f"Updated {listing.title}: {amenities}")
    
    return {"updated": len(listings)}

API ENDPOINT:
------------

@router.post("/listings/extract-all-amenities")
async def bulk_extract():
    result = await extract_all_amenities()
    return result

===================================================================================
                         ENABLING BETTER SEARCH
===================================================================================

WHY EXTRACT AMENITIES?
---------------------

Before extraction:
    User: "Find hotels with pool"
    System: *Can't search - no structured data*
    
After extraction:
    User: "Find hotels with pool"
    System: Listing.find({"amenities": "Pool"})
    Result: All hotels with pools!


MONGODB QUERIES WITH AMENITIES:
------------------------------

# Find hotels with specific amenity
Listing.find({"amenities": "WiFi"})

# Find hotels with multiple amenities
Listing.find({"amenities": {"$all": ["WiFi", "Pool", "Parking"]}})

# Find hotels with any of these amenities
Listing.find({"amenities": {"$in": ["Pool", "Beach Access"]}})

# Count hotels by amenity
Listing.aggregate([
    {"$unwind": "$amenities"},
    {"$group": {"_id": "$amenities", "count": {"$sum": 1}}},
    {"$sort": {"count": -1}}
])

===================================================================================
                         SMART HOTEL FINDER
===================================================================================

COMBINES NLP + SEARCH:
---------------------

User query: "I need a budget hotel near beach with WiFi and parking"

STEP 1: Parse query with GPT-4
    {
        "location": "beach",
        "price_range": "budget",
        "required_amenities": ["WiFi", "Parking"]
    }

STEP 2: MongoDB query
    Listing.find({
        "location": {"$regex": "beach", "$options": "i"},
        "price": {"$lt": 3000},
        "amenities": {"$all": ["WiFi", "Parking"]}
    })

STEP 3: Return matching hotels

===================================================================================
                         INTERVIEW TALKING POINTS
===================================================================================

1. "I used GPT-4 function calling to extract structured data from text"

2. "This converts unstructured hotel descriptions into searchable amenities"

3. "Function calling ensures consistent JSON output, unlike free-text responses"

4. "I ran bulk extraction on 100+ listings to populate the amenities field"

5. "This enables natural language hotel search - users can ask for 
    'hotels with pool and WiFi' and get accurate results"

6. "It's a practical NLP application that improves user experience"

===================================================================================
                         KEY CONCEPTS
===================================================================================

FUNCTION CALLING:
- Define function schema (name, parameters)
- GPT-4 returns structured JSON
- More reliable than parsing text

NLP EXTRACTION:
- Unstructured text â†’ Structured data
- Enables database queries
- Scales to any number of documents

USE CASES:
- Amenity extraction (this project)
- Entity extraction (names, places)
- Sentiment analysis
- Data normalization

===================================================================================
                         QUICK REFERENCE
===================================================================================

Flow:
    Description â†’ GPT-4 Function Call â†’ JSON Array â†’ MongoDB

Code Pattern:
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[...],
        functions=[function_schema],
        function_call={"name": "function_name"}
    )
    result = json.loads(response.choices[0].message.function_call.arguments)

MongoDB Schema:
    amenities: {
        type: [String],
        default: []
    }

Search:
    Listing.find({"amenities": {"$all": ["WiFi", "Pool"]}})

===================================================================================

