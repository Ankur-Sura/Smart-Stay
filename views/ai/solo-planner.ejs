<%#
===================================================================================
                    SOLO-PLANNER.EJS - Solo Trip Planner (Human-in-the-Loop)
===================================================================================

ğŸ“š WHAT IS THIS FILE?
---------------------
This is the SOLO TRIP PLANNER page with Human-in-the-Loop (HITL) interaction.
The AI asks questions and waits for user responses before planning.

ğŸ”— ROUTES:
   GET /ai/solo-planner (displays this page)
   POST /api/travel/solo/start (starts planning, returns questions)
   POST /api/travel/solo/resume (continues with user answers)

ğŸ“Œ HOW HITL WORKS (11-Node LangGraph Workflow):
----------------------------------------------
1. User starts: "Plan a solo trip to Goa"
2. AI processes initial request (nodes 1-3)
3. AI PAUSES and asks questions:
   - "What's your travel mode preference?"
   - "Food preference (veg/non-veg)?"
   - "Budget level?"
4. User answers questions (stored in state)
5. AI RESUMES with answers (nodes 5-11)
6. Personalized itinerary generated

ğŸ“Œ STATE MANAGEMENT:
-------------------
- thread_id: Unique ID for this conversation
- State saved to MongoDB (MongoDBSaver)
- Can resume even after page refresh

ğŸ“Œ UI PHASES:
------------
Phase 1: User enters initial query
Phase 2: AI asks questions (user selects answers)
Phase 3: AI generates personalized plan

ğŸ“– INTERVIEW TIP:
----------------
"The Solo Trip Planner implements Human-in-the-Loop using LangGraph's
interrupt() function. The workflow pauses after initial processing,
asks the user preference questions, then resumes with their answers.
State is persisted to MongoDB so conversations survive page refreshes."

===================================================================================
%>
<% layout("layouts/boilerplate") -%>

<style>
  <%# Hero section with pink/red gradient (solo travel theme) %>
  .solo-hero {
    background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%);
    color: white;
    padding: 2.5rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 40px 40px;
    box-shadow: 0 10px 30px rgba(244, 63, 94, 0.3);
  }
  
  .chat-container {
    max-width: 950px;
    margin: 0 auto;
  }
  
  .chat-card {
    border: none;
    border-radius: 25px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.12);
    overflow: hidden;
    background: white;
  }
  
  .chat-header {
    background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%);
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .chat-messages {
    height: 550px;
    overflow-y: auto;
    padding: 1.5rem;
    background: linear-gradient(180deg, #fff1f2 0%, #ffe4e6 100%);
  }
  
  .message {
    display: flex;
    margin-bottom: 1.5rem;
    animation: slideIn 0.3s ease;
  }
  
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .message.user { justify-content: flex-end; }
  
  .message-bubble {
    max-width: 85%;
    padding: 1.25rem 1.5rem;
    border-radius: 20px;
    position: relative;
    word-wrap: break-word;
    font-size: 0.95rem;
    line-height: 1.7;
  }
  
  .message.user .message-bubble {
    background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%);
    color: white;
    border-bottom-right-radius: 5px;
  }
  
  .message.ai .message-bubble {
    background: white;
    border: 1px solid #fecdd3;
    border-bottom-left-radius: 5px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06);
  }
  
  .message-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    margin: 0 0.75rem;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .message.user .message-avatar { background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%); order: 1; }
  .message.ai .message-avatar { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
  
  .workflow-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    background: rgba(255,255,255,0.2);
    color: white;
    padding: 0.4rem 1rem;
    border-radius: 50px;
    font-size: 0.8rem;
    font-weight: 500;
    backdrop-filter: blur(10px);
  }
  
  .chat-input-container {
    padding: 1.5rem;
    background: white;
    border-top: 1px solid #fecdd3;
  }
  
  .chat-input {
    flex: 1;
    border: 2px solid #fecdd3;
    border-radius: 15px;
    padding: 0.85rem 1.5rem;
    font-size: 1rem;
    resize: none;
    transition: all 0.3s ease;
    background: #fff5f5;
  }
  
  .chat-input:focus {
    outline: none;
    border-color: #f43f5e;
    box-shadow: 0 0 0 4px rgba(244, 63, 94, 0.15);
    background: white;
  }
  
  .btn-start {
    background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%);
    border: none;
    border-radius: 15px;
    padding: 1rem 2rem;
    color: white;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3);
  }
  
  .btn-start:hover:not(:disabled) {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(244, 63, 94, 0.4);
    color: white;
  }
  
  .btn-start:disabled {
    background: #9ca3af;
    box-shadow: none;
    transform: none;
  }
  
  /* Question Form Styling */
  .question-card {
    background: linear-gradient(135deg, #fff5f5 0%, #ffe4e6 100%);
    border-radius: 16px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }
  
  .question-card:hover {
    border-color: #f43f5e;
    transform: translateY(-2px);
  }
  
  .question-card label {
    font-weight: 700;
    color: #9f1239;
    margin-bottom: 0.75rem;
    display: block;
    font-size: 0.95rem;
  }
  
  .form-select {
    border: 2px solid #fecdd3;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    background-color: white;
    transition: all 0.3s ease;
  }
  
  .form-select:focus {
    border-color: #f43f5e;
    box-shadow: 0 0 0 4px rgba(244, 63, 94, 0.15);
  }
  
  /* Workflow Info Card */
  .workflow-info {
    background: linear-gradient(135deg, #fff5f5 0%, #ffe4e6 100%);
    border-radius: 20px;
    padding: 1.75rem;
    margin-top: 2rem;
    border: 2px solid #fecdd3;
  }
  
  .workflow-info h6 {
    color: #9f1239;
    font-size: 1.1rem;
    margin-bottom: 1.25rem;
  }
  
  .step-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 0;
    font-size: 0.9rem;
  }
  
  .step-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%);
    color: white;
    border-radius: 50%;
    font-size: 0.8rem;
    font-weight: 700;
    margin-right: 0.75rem;
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(244, 63, 94, 0.3);
  }
  
  /* ===== IMPROVED CONTENT STYLING ===== */
  
  .info-section {
    margin: 1.25rem 0;
    padding: 1.5rem;
    background: linear-gradient(135deg, #fff5f5 0%, #ffe4e6 100%);
    border-radius: 16px;
    border-left: 5px solid;
    box-shadow: 0 2px 10px rgba(0,0,0,0.04);
  }
  
  .info-section.destination { border-left-color: #10b981; }
  .info-section.transport { border-left-color: #f59e0b; }
  .info-section.accommodation { border-left-color: #3b82f6; }
  .info-section.activities { border-left-color: #8b5cf6; }
  .info-section.food { border-left-color: #ec4899; }
  .info-section.shopping { border-left-color: #06b6d4; }
  .info-section.requirements { border-left-color: #14b8a6; }
  .info-section.emergency { border-left-color: #ef4444; }
  .info-section.package { border-left-color: #f43f5e; background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%); }
  
  .info-section h4 {
    margin: 0 0 1rem 0;
    color: #9f1239;
    font-size: 1.15rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  /* Markdown Content Styling */
  .md-content {
    font-size: 0.95rem;
    line-height: 1.8;
    color: #374151;
  }
  
  .md-content h1, .md-content h2, .md-content h3, .md-content h4, .md-content h5 {
    color: #9f1239;
    margin: 1.5rem 0 0.75rem 0;
    font-weight: 700;
    line-height: 1.4;
  }
  
  .md-content h1 { font-size: 1.5rem; border-bottom: 2px solid #fecdd3; padding-bottom: 0.5rem; }
  .md-content h2 { font-size: 1.3rem; color: #be123c; }
  .md-content h3 { font-size: 1.15rem; color: #e11d48; }
  .md-content h4 { font-size: 1.05rem; }
  
  .md-content p { margin: 0.75rem 0; }
  
  .md-content strong, .md-content b {
    font-weight: 700;
    color: #111827;
  }
  
  .md-content ul, .md-content ol {
    margin: 0.75rem 0;
    padding-left: 1.5rem;
  }
  
  .md-content li {
    margin: 0.5rem 0;
  }
  
  .md-content ul li::marker {
    color: #f43f5e;
  }
  
  /* Table Styling */
  .md-content table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 1.25rem 0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  
  .md-content table th {
    background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%);
    color: white;
    padding: 1rem 1.25rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .md-content table td {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #fecdd3;
    background: white;
    font-size: 0.95rem;
  }
  
  .md-content table tr:last-child td {
    border-bottom: none;
  }
  
  .md-content table tr:nth-child(even) td {
    background: #fff5f5;
  }
  
  .md-content table tr:hover td {
    background: #ffe4e6;
  }
  
  /* Links */
  .md-content a {
    color: #f43f5e;
    text-decoration: none;
    font-weight: 600;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
  }
  
  .md-content a:hover {
    color: #be123c;
    border-bottom-color: #be123c;
  }
  
  /* Horizontal Rule */
  .md-content hr {
    border: none;
    height: 2px;
    background: linear-gradient(90deg, transparent, #fecdd3, transparent);
    margin: 1.5rem 0;
  }
  
  /* Code blocks */
  .md-content code {
    background: #ffe4e6;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9em;
    color: #be123c;
  }
  
  /* Blockquote */
  .md-content blockquote {
    border-left: 4px solid #f43f5e;
    margin: 1rem 0;
    padding: 0.75rem 1.25rem;
    background: #fff5f5;
    border-radius: 0 8px 8px 0;
    font-style: italic;
  }
  
  /* Trip Header */
  .trip-header {
    background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 16px;
    margin-bottom: 1.5rem;
    text-align: center;
    box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3);
  }
  
  .trip-header h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.4rem;
  }
  
  .trip-details {
    display: flex;
    justify-content: center;
    gap: 2rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
  
  .trip-detail {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255,255,255,0.2);
    padding: 0.5rem 1rem;
    border-radius: 25px;
    backdrop-filter: blur(10px);
  }
  
  /* Workflow Complete Badge */
  .workflow-complete {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
    margin-top: 1.5rem;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }
  
  /* Typing Indicator */
  .typing-indicator {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem 0;
  }
  
  .typing-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f43f5e 0%, #be123c 100%);
    animation: typing 1.4s infinite;
  }
  
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  
  @keyframes typing {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
    30% { transform: translateY(-12px); opacity: 1; }
  }
</style>

<!-- Hero Section -->
<div class="solo-hero text-center">
  <div class="container">
    <h1 class="display-5 fw-bold mb-2">ğŸ’ Solo Trip Planner</h1>
    <p class="lead mb-0">11-Node Human-in-the-Loop â€¢ Personalized Adventure Planning</p>
  </div>
</div>

<div class="container chat-container pb-5">
  <div class="chat-card">
    <div class="chat-header text-white">
      <div>
        <h5 class="mb-0 fw-bold">ğŸ’ Plan Your Solo Adventure</h5>
        <small class="opacity-75">Human-in-the-Loop AI Planning</small>
      </div>
      <div class="workflow-badge">
        <span>ğŸ“Š</span>
        <span>11 Nodes</span>
      </div>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="message ai">
        <div class="message-avatar">ğŸ’</div>
        <div class="message-bubble">
          <strong>Hello Solo Traveler! ğŸ‘‹</strong><br><br>
          I'm your personal trip planning assistant. I'll help you create the perfect solo adventure using my 11-node AI workflow.
          <br><br>
          <strong>What I'll help you with:</strong>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li>ğŸ—ºï¸ Destination research</li>
            <li>ğŸš— Transport planning (including EV charging stops!)</li>
            <li>ğŸ¨ Solo-friendly accommodations</li>
            <li>ğŸ¯ Activities & hidden gems</li>
            <li>ğŸ½ï¸ Local cuisine guide</li>
            <li>ğŸ›ï¸ Shopping recommendations</li>
            <li>ğŸš¨ Safety & emergency info</li>
          </ul>
          <br>
          <strong>Try:</strong> "Plan a solo trip from Delhi to Goa for 5 days"
        </div>
      </div>
    </div>
    
    <div class="chat-input-container">
      <form id="startForm">
        <div class="mb-3">
          <textarea class="form-control chat-input" id="tripQuery" rows="2" placeholder="e.g., Plan a solo trip from Mumbai to Kerala for 7 days"></textarea>
        </div>
        <button type="submit" class="btn btn-start w-100" id="startBtn">
          ğŸš€ Start Planning My Trip
        </button>
      </form>
      
      <form id="responseForm" style="display: none;">
        <div id="questionsContainer"></div>
        <button type="submit" class="btn btn-start w-100 mt-3" id="submitResponseBtn">
          âœ¨ Generate My Personalized Itinerary
        </button>
      </form>
    </div>
  </div>
  
  <!-- Workflow Info -->
  <div class="workflow-info">
    <h6 class="fw-bold">ğŸ“Š 11-Node Human-in-the-Loop Workflow</h6>
    <div class="row">
      <div class="col-md-6">
        <div class="step-item"><span class="step-badge">1</span> Parse your travel request</div>
        <div class="step-item"><span class="step-badge">2</span> Research destination</div>
        <div class="step-item"><span class="step-badge">3</span> Discover transport options</div>
        <div class="step-item"><span class="step-badge">4</span> <strong>ğŸ›‘ Ask your preferences</strong></div>
        <div class="step-item"><span class="step-badge">5</span> Create transport plan</div>
        <div class="step-item"><span class="step-badge">6</span> Find accommodations</div>
      </div>
      <div class="col-md-6">
        <div class="step-item"><span class="step-badge">7</span> Plan activities</div>
        <div class="step-item"><span class="step-badge">8</span> Create food guide</div>
        <div class="step-item"><span class="step-badge">9</span> Shopping recommendations</div>
        <div class="step-item"><span class="step-badge">10</span> Add safety info</div>
        <div class="step-item"><span class="step-badge">11</span> Build final package</div>
      </div>
    </div>
  </div>
</div>

<!-- Include marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
let threadId = null;
const chatMessages = document.getElementById('chatMessages');
const startForm = document.getElementById('startForm');
const responseForm = document.getElementById('responseForm');
const questionsContainer = document.getElementById('questionsContainer');

// Configure marked for better rendering
if (typeof marked !== 'undefined') {
  marked.setOptions({
    gfm: true,
    breaks: true,
    tables: true
  });
}

// Markdown parser
function parseMarkdown(text) {
  if (typeof marked !== 'undefined') {
    return marked.parse(text);
  }
  
  // Fallback simple parser
  let html = text
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>')
    .replace(/^---$/gim, '<hr>')
    .replace(/\n/g, '<br>');
  
  return html;
}

function addMessage(content, isUser = false) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = isUser ? 'ğŸ‘¤' : 'ğŸ’';
  
  const bubble = document.createElement('div');
  bubble.className = 'message-bubble';
  bubble.innerHTML = content;
  
  messageDiv.appendChild(avatar);
  messageDiv.appendChild(bubble);
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showTyping() {
  const typingDiv = document.createElement('div');
  typingDiv.className = 'message ai';
  typingDiv.id = 'typingIndicator';
  
  const avatar = document.createElement('div');
  avatar.className = 'message-avatar';
  avatar.textContent = 'ğŸ’';
  
  const bubble = document.createElement('div');
  bubble.className = 'message-bubble';
  bubble.innerHTML = `
    <div class="typing-indicator">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
    <small style="color: #9f1239; margin-top: 0.5rem; display: block;">Planning your adventure...</small>
  `;
  
  typingDiv.appendChild(avatar);
  typingDiv.appendChild(bubble);
  chatMessages.appendChild(typingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function hideTyping() {
  const typing = document.getElementById('typingIndicator');
  if (typing) typing.remove();
}

function showQuestions(questions) {
  questionsContainer.innerHTML = '';
  
  if (questions.travel_mode) {
    questionsContainer.innerHTML += `
      <div class="question-card">
        <label>ğŸš— How would you like to travel?</label>
        <select class="form-select" id="travel_mode" required>
          <option value="">Select travel mode</option>
          <option value="personal_vehicle">ğŸš— Personal Vehicle</option>
          <option value="public_transport">ğŸš‚ Public Transport (Train/Bus)</option>
          <option value="taxi">ğŸš• Taxi/Cab</option>
          <option value="flight">âœˆï¸ Flight</option>
        </select>
      </div>
    `;
  }
  
  if (questions.food_preference) {
    questionsContainer.innerHTML += `
      <div class="question-card">
        <label>ğŸ½ï¸ What's your food preference?</label>
        <select class="form-select" id="food_preference" required>
          <option value="">Select preference</option>
          <option value="veg">ğŸ¥— Vegetarian</option>
          <option value="non_veg">ğŸ— Non-Vegetarian</option>
          <option value="vegan">ğŸŒ± Vegan</option>
          <option value="eggetarian">ğŸ¥š Eggetarian</option>
        </select>
      </div>
    `;
  }
  
  if (questions.budget_level) {
    questionsContainer.innerHTML += `
      <div class="question-card">
        <label>ğŸ’° What's your budget level?</label>
        <select class="form-select" id="budget_level" required>
          <option value="">Select budget</option>
          <option value="budget">ğŸ’µ Budget (â‚¹500-1,500/day)</option>
          <option value="mid_range">ğŸ’ Mid-Range (â‚¹1,500-4,000/day)</option>
          <option value="premium">ğŸ‘‘ Premium (â‚¹4,000+/day)</option>
        </select>
      </div>
    `;
  }
  
  if (questions.accommodation_type) {
    questionsContainer.innerHTML += `
      <div class="question-card">
        <label>ğŸ¨ Where do you prefer to stay?</label>
        <select class="form-select" id="accommodation_type" required>
          <option value="">Select accommodation</option>
          <option value="hotel">ğŸ¨ Hotel</option>
          <option value="hostel">ğŸ›ï¸ Hostel</option>
          <option value="airbnb">ğŸ  Airbnb/Homestay</option>
          <option value="camping">â›º Camping</option>
          <option value="none">ğŸš— No Stay (Day Trip)</option>
        </select>
      </div>
    `;
  }
  
  startForm.style.display = 'none';
  responseForm.style.display = 'block';
}

function formatSoloTripResponse(data) {
  let html = '';
  
  // Trip Header
  if (data.origin && data.destination) {
    html += `
      <div class="trip-header">
        <h3>ğŸ’ Your Solo Trip to ${data.destination}</h3>
        <div class="trip-details">
          <div class="trip-detail"><span>ğŸ“</span> From: <strong>${data.origin}</strong></div>
          <div class="trip-detail"><span>ğŸ¯</span> To: <strong>${data.destination}</strong></div>
          ${data.distance_km ? `<div class="trip-detail"><span>ğŸ“</span> Distance: <strong>${data.distance_km} km</strong></div>` : ''}
        </div>
      </div>
    `;
  }
  
  // Final Package
  if (data.final_package) {
    html += `
      <div class="info-section package">
        <h4><span>âœ¨</span> Your Complete Solo Trip Package</h4>
        <div class="md-content">${parseMarkdown(data.final_package)}</div>
      </div>
    `;
  }
  
  // Individual sections if available
  if (data.destination_info) {
    html += `
      <div class="info-section destination">
        <h4><span>ğŸŒ</span> Destination Overview</h4>
        <div class="md-content">${parseMarkdown(data.destination_info)}</div>
      </div>
    `;
  }
  
  if (data.personalized_transport) {
    html += `
      <div class="info-section transport">
        <h4><span>ğŸš—</span> Your Transport Plan</h4>
        <div class="md-content">${parseMarkdown(data.personalized_transport)}</div>
      </div>
    `;
  }
  
  if (data.accommodation_plan) {
    html += `
      <div class="info-section accommodation">
        <h4><span>ğŸ¨</span> Accommodation</h4>
        <div class="md-content">${parseMarkdown(data.accommodation_plan)}</div>
      </div>
    `;
  }
  
  if (data.activities_plan) {
    html += `
      <div class="info-section activities">
        <h4><span>ğŸ¯</span> Activities</h4>
        <div class="md-content">${parseMarkdown(data.activities_plan)}</div>
      </div>
    `;
  }
  
  if (data.food_guide) {
    html += `
      <div class="info-section food">
        <h4><span>ğŸ½ï¸</span> Food Guide</h4>
        <div class="md-content">${parseMarkdown(data.food_guide)}</div>
      </div>
    `;
  }
  
  if (data.shopping_guide) {
    html += `
      <div class="info-section shopping">
        <h4><span>ğŸ›ï¸</span> Shopping Guide</h4>
        <div class="md-content">${parseMarkdown(data.shopping_guide)}</div>
      </div>
    `;
  }
  
  if (data.emergency_info) {
    html += `
      <div class="info-section emergency">
        <h4><span>ğŸš¨</span> Emergency & Safety</h4>
        <div class="md-content">${parseMarkdown(data.emergency_info)}</div>
      </div>
    `;
  }
  
  // Workflow Complete Badge
  html += `
    <div style="text-align: center;">
      <div class="workflow-complete">
        <span>âœ…</span>
        <span>11-Node Workflow Complete</span>
      </div>
    </div>
  `;
  
  return html || '<em>Processing your trip...</em>';
}

// Start planning
startForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const query = document.getElementById('tripQuery').value;
  if (!query) return;
  
  addMessage(query, true);
  document.getElementById('tripQuery').value = '';
  document.getElementById('startBtn').disabled = true;
  document.getElementById('startBtn').innerHTML = 'â³ Processing...';
  
  showTyping();
  
  try {
    const response = await fetch('/api/travel/solo/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query })
    });
    
    const data = await response.json();
    hideTyping();
    
    if (data.error) {
      addMessage(`<div class="info-section emergency"><h4>âŒ Error</h4><p>${data.error}</p></div>`);
      return;
    }
    
    if (!data.success) {
      addMessage(`<div class="info-section emergency"><h4>âŒ Error</h4><p>${data.message || 'Failed to start planning'}</p></div>`);
      return;
    }
    
    threadId = data.thread_id;
    
    if (data.status === 'awaiting_input' && data.questions) {
      // Show destination info if available
      if (data.destination) {
        addMessage(`
          <div class="trip-header" style="margin: 0;">
            <h3 style="font-size: 1.2rem;">ğŸ—ºï¸ Trip Details Found!</h3>
            <div class="trip-details">
              <div class="trip-detail"><span>ğŸ“</span> From: <strong>${data.origin || 'Your location'}</strong></div>
              <div class="trip-detail"><span>ğŸ¯</span> To: <strong>${data.destination}</strong></div>
              ${data.distance_km ? `<div class="trip-detail"><span>ğŸ“</span> <strong>${data.distance_km} km</strong></div>` : ''}
            </div>
          </div>
        `);
      }
      
      addMessage(`
        <strong>ğŸ¤” Let me personalize your trip!</strong><br><br>
        Please answer these quick questions so I can create the perfect solo adventure for you.
      `);
      
      const questionsObj = {};
      if (data.questions && data.questions.fields) {
        data.questions.fields.forEach(field => {
          if (field.id === 'travel_mode') questionsObj.travel_mode = true;
          if (field.id === 'food_preference') questionsObj.food_preference = true;
          if (field.id === 'budget_level') questionsObj.budget_level = true;
          if (field.id === 'accommodation_type') questionsObj.accommodation_type = true;
        });
      }
      
      showQuestions(questionsObj);
    } else if (data.final_package) {
      addMessage(formatSoloTripResponse(data));
    } else if (data.message) {
      addMessage(`â„¹ï¸ ${data.message}`);
    } else {
      addMessage(`<div class="info-section emergency"><h4>âŒ Unexpected Response</h4><p>Please try again.</p></div>`);
      console.error('Unexpected response:', data);
    }
    
  } catch (error) {
    hideTyping();
    console.error('Solo trip start error:', error);
    let errorMsg = error.message;
    if (error.message.includes('Failed to fetch')) {
      errorMsg = 'Cannot connect to AI service. Make sure FastAPI is running on port 8000.';
    }
    addMessage(`<div class="info-section emergency"><h4>âŒ Connection Error</h4><p>${errorMsg}</p></div>`);
  } finally {
    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').innerHTML = 'ğŸš€ Start Planning My Trip';
  }
});

// Submit responses
responseForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const responses = {};
  
  if (document.getElementById('travel_mode')) {
    responses.travel_mode = document.getElementById('travel_mode').value;
  }
  if (document.getElementById('food_preference')) {
    responses.food_preference = document.getElementById('food_preference').value;
  }
  if (document.getElementById('budget_level')) {
    responses.budget_level = document.getElementById('budget_level').value;
  }
  if (document.getElementById('accommodation_type')) {
    responses.accommodation_type = document.getElementById('accommodation_type').value;
  }
  
  // Validate required fields
  if (!responses.travel_mode || !responses.food_preference || !responses.budget_level || !responses.accommodation_type) {
    addMessage(`<div class="info-section emergency"><h4>âš ï¸ Missing Information</h4><p>Please fill in all the questions above.</p></div>`);
    return;
  }
  
  const modeLabels = {
    'personal_vehicle': 'ğŸš— Personal Vehicle',
    'public_transport': 'ğŸš‚ Public Transport',
    'taxi': 'ğŸš• Taxi/Cab',
    'flight': 'âœˆï¸ Flight'
  };
  
  const foodLabels = {
    'veg': 'ğŸ¥— Vegetarian',
    'non_veg': 'ğŸ— Non-Vegetarian',
    'vegan': 'ğŸŒ± Vegan',
    'eggetarian': 'ğŸ¥š Eggetarian'
  };
  
  const budgetLabels = {
    'budget': 'ğŸ’µ Budget',
    'mid_range': 'ğŸ’ Mid-Range',
    'premium': 'ğŸ‘‘ Premium'
  };
  
  const accLabels = {
    'hotel': 'ğŸ¨ Hotel',
    'hostel': 'ğŸ›ï¸ Hostel',
    'airbnb': 'ğŸ  Airbnb',
    'camping': 'â›º Camping',
    'none': 'ğŸš— Day Trip'
  };
  
  addMessage(`
    <strong>My Preferences:</strong><br>
    <div style="margin-top: 0.5rem;">
      ${modeLabels[responses.travel_mode] || responses.travel_mode}<br>
      ${foodLabels[responses.food_preference] || responses.food_preference}<br>
      ${budgetLabels[responses.budget_level] || responses.budget_level}<br>
      ${accLabels[responses.accommodation_type] || responses.accommodation_type}
    </div>
  `, true);
  
  document.getElementById('submitResponseBtn').disabled = true;
  document.getElementById('submitResponseBtn').innerHTML = 'â³ Creating your itinerary...';
  
  showTyping();
  
  try {
    const response = await fetch('/api/travel/solo/resume', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        thread_id: threadId,
        user_responses: responses
      })
    });
    
    const data = await response.json();
    hideTyping();
    
    if (data.error) {
      addMessage(`<div class="info-section emergency"><h4>âŒ Error</h4><p>${data.error}</p></div>`);
      return;
    }
    
    if (data.final_package || data.final_itinerary) {
      const finalData = {
        ...data,
        final_package: data.final_package || data.final_itinerary
      };
      addMessage(formatSoloTripResponse(finalData));
    } else if (data.error) {
      addMessage(`<div class="info-section emergency"><h4>âŒ Error</h4><p>${data.error}</p></div>`);
    } else {
      addMessage(`â„¹ï¸ ${data.message || 'Processing complete.'}`);
      console.log('Response data:', data);
    }
    
    responseForm.style.display = 'none';
    startForm.style.display = 'block';
    
  } catch (error) {
    hideTyping();
    console.error('Solo trip resume error:', error);
    let errorMsg = error.message;
    if (error.message.includes('Failed to fetch')) {
      errorMsg = 'Cannot connect to AI service. Make sure FastAPI is running on port 8000.';
    }
    addMessage(`<div class="info-section emergency"><h4>âŒ Connection Error</h4><p>${errorMsg}</p></div>`);
  } finally {
    document.getElementById('submitResponseBtn').disabled = false;
    document.getElementById('submitResponseBtn').innerHTML = 'âœ¨ Generate My Personalized Itinerary';
  }
});
</script>
