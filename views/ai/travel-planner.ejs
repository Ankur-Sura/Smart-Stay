<%#
===================================================================================
                    TRAVEL-PLANNER.EJS - Travel Planner Form Interface
===================================================================================

ğŸ“š WHAT IS THIS FILE?
---------------------
This is an ALTERNATIVE Travel Planner interface with a traditional form layout.
(The chat version is travel-chat.ejs)

ğŸ”— ROUTE: GET /ai/travel-planner (redirects to /ai/travel-chat)
   API: POST /api/travel/plan

ğŸ“Œ FORM FIELDS:
--------------
- Destination: Where to travel
- Source: Starting location
- Duration: Number of days
- Budget: Budget level preference
- Preferences: Food, accommodation type, activities

ğŸ“Œ DIFFERENCE FROM TRAVEL-CHAT:
------------------------------
- travel-planner.ejs: Form-based input (structured)
- travel-chat.ejs: Chat-based input (natural language)

Both call the same API and LangGraph workflow!

ğŸ“– NOTE:
-------
This page may redirect to travel-chat.ejs for a better UX.
The chat interface is more intuitive for travel planning.

===================================================================================
%>
<% layout("layouts/boilerplate") -%>

<style>
  <%# Hero section with blue gradient (travel theme) %>
  .travel-hero {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 30px 30px;
  }
  
  .input-card {
    border: none;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  
  .input-card .card-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    border: none;
    padding: 1.5rem;
  }
  
  .result-card {
    border: none;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  
  .result-card .card-header {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    padding: 1.5rem;
  }
  
  .form-control, .form-select {
    border-radius: 10px;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .btn-generate {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    border: none;
    border-radius: 10px;
    padding: 1rem;
    font-weight: 600;
    font-size: 1.1rem;
    transition: all 0.3s ease;
  }
  
  .btn-generate:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
  }
  
  .btn-generate:disabled {
    background: #94a3b8;
    transform: none;
    box-shadow: none;
  }
  
  .workflow-mini {
    background: #f8fafc;
    border-radius: 15px;
    padding: 1.5rem;
    margin-top: 1.5rem;
  }
  
  .workflow-step-mini {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
    border-bottom: 1px dashed #e2e8f0;
  }
  
  .workflow-step-mini:last-child {
    border-bottom: none;
  }
  
  .step-number {
    width: 28px;
    height: 28px;
    background: #3b82f6;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
    flex-shrink: 0;
  }
  
  .result-content {
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
    padding: 1.5rem;
    background: #f8fafc;
  }
  
  .result-section {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border-left: 4px solid #3b82f6;
  }
  
  .result-section h5 {
    color: #1e40af;
    margin-bottom: 1rem;
  }
  
  .loading-animation {
    text-align: center;
    padding: 3rem;
  }
  
  .loading-animation .spinner {
    width: 60px;
    height: 60px;
    border: 4px solid #e2e8f0;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .loading-steps {
    margin-top: 2rem;
  }
  
  .loading-step {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    color: #64748b;
  }
  
  .loading-step.active {
    color: #3b82f6;
    font-weight: 600;
  }
  
  .loading-step.done {
    color: #10b981;
  }
  
  .loading-step .icon {
    font-size: 1.25rem;
  }
  
  .example-queries {
    background: #f0f9ff;
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
  }
  
  .example-query {
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 5px;
    margin-bottom: 0.25rem;
    transition: all 0.2s ease;
  }
  
  .example-query:hover {
    background: #dbeafe;
  }
</style>

<!-- Hero Section -->
<div class="travel-hero text-center">
  <div class="container">
    <h2 class="fw-bold mb-2">ğŸ§³ AI Travel Planner</h2>
    <p class="opacity-90 mb-0">Generate complete travel itineraries using 8-node LangGraph workflow</p>
  </div>
</div>

<div class="container pb-5">
  <div class="row g-4">
    <!-- Input Form -->
    <div class="col-lg-5">
      <div class="card input-card">
        <div class="card-header text-white">
          <h5 class="mb-0 fw-bold">âœˆï¸ Plan Your Trip</h5>
        </div>
        <div class="card-body p-4">
          <form id="travelForm">
            <div class="mb-3">
              <label for="query" class="form-label fw-semibold">Describe your trip:</label>
              <textarea class="form-control" id="query" rows="3" placeholder="e.g., Plan a 5-day trip from Mumbai to Goa for a family of 4" required></textarea>
            </div>
            
            <div class="row">
              <div class="col-6 mb-3">
                <label for="source" class="form-label fw-semibold">From:</label>
                <input type="text" class="form-control" id="source" placeholder="e.g., Mumbai">
              </div>
              <div class="col-6 mb-3">
                <label for="destination" class="form-label fw-semibold">To:</label>
                <input type="text" class="form-control" id="destination" placeholder="e.g., Goa">
              </div>
            </div>
            
            <div class="row">
              <div class="col-6 mb-3">
                <label class="form-label fw-semibold">Food:</label>
                <select class="form-select" id="food_preference">
                  <option value="">Any</option>
                  <option value="veg">ğŸ¥— Vegetarian</option>
                  <option value="non_veg">ğŸ— Non-Vegetarian</option>
                  <option value="vegan">ğŸŒ± Vegan</option>
                </select>
              </div>
              <div class="col-6 mb-3">
                <label class="form-label fw-semibold">Budget:</label>
                <select class="form-select" id="budget">
                  <option value="">Any</option>
                  <option value="budget">ğŸ’° Budget</option>
                  <option value="midrange">ğŸ’ Mid-Range</option>
                  <option value="luxury">ğŸ‘‘ Luxury</option>
                </select>
              </div>
            </div>
            
            <button type="submit" class="btn btn-generate text-white w-100" id="submitBtn">
              ğŸš€ Generate Itinerary
            </button>
          </form>
          
          <!-- Example Queries -->
          <div class="example-queries">
            <small class="text-muted fw-semibold">ğŸ’¡ Try these examples:</small>
            <div class="example-query" onclick="fillExample('Plan a 5-day trip from Mumbai to Goa for a couple', 'Mumbai', 'Goa')">
              <small>ğŸ–ï¸ Mumbai to Goa for couples</small>
            </div>
            <div class="example-query" onclick="fillExample('Plan a 3-day trip from Delhi to Jaipur for family with kids', 'Delhi', 'Jaipur')">
              <small>ğŸ° Delhi to Jaipur family trip</small>
            </div>
            <div class="example-query" onclick="fillExample('Plan a 7-day trip from Bangalore to Kerala backwaters', 'Bangalore', 'Kerala')">
              <small>ğŸ›¶ Bangalore to Kerala backwaters</small>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Workflow Info -->
      <div class="workflow-mini">
        <h6 class="fw-bold mb-3">ğŸ“Š 8-Node Workflow</h6>
        <div class="workflow-step-mini">
          <span class="step-number">1</span>
          <span>ğŸ—ºï¸ Destination Research</span>
        </div>
        <div class="workflow-step-mini">
          <span class="step-number">2</span>
          <span>ğŸš„ Transport Finder</span>
        </div>
        <div class="workflow-step-mini">
          <span class="step-number">3</span>
          <span>ğŸ¨ Accommodation</span>
        </div>
        <div class="workflow-step-mini">
          <span class="step-number">4</span>
          <span>ğŸ¯ Activities Planner</span>
        </div>
        <div class="workflow-step-mini">
          <span class="step-number">5</span>
          <span>ğŸ½ï¸ Food & Shopping</span>
        </div>
        <div class="workflow-step-mini">
          <span class="step-number">6</span>
          <span>ğŸ“‹ Travel Requirements</span>
        </div>
        <div class="workflow-step-mini">
          <span class="step-number">7</span>
          <span>ğŸš¨ Emergency Info</span>
        </div>
        <div class="workflow-step-mini">
          <span class="step-number">8</span>
          <span>ğŸ“¦ Package Builder</span>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div class="col-lg-7">
      <div class="card result-card">
        <div class="card-header text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-bold">ğŸ“‹ Generated Itinerary</h5>
          <span class="badge bg-white text-success" id="statusBadge">Ready</span>
        </div>
        <div class="result-content" id="result">
          <div class="text-center py-5">
            <div style="font-size: 4rem; opacity: 0.3;">âœˆï¸</div>
            <h5 class="text-muted">Your travel itinerary will appear here</h5>
            <p class="text-muted small">Fill in the form and click "Generate Itinerary"</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function fillExample(query, source, destination) {
  document.getElementById('query').value = query;
  document.getElementById('source').value = source;
  document.getElementById('destination').value = destination;
}

document.getElementById('travelForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submitBtn');
  const resultDiv = document.getElementById('result');
  const statusBadge = document.getElementById('statusBadge');
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = 'â³ Generating...';
  statusBadge.className = 'badge bg-warning text-dark';
  statusBadge.textContent = 'Processing';
  
  resultDiv.innerHTML = `
    <div class="loading-animation">
      <div class="spinner mx-auto"></div>
      <h5 class="mt-4 text-primary">AI is planning your trip...</h5>
      <p class="text-muted">This may take 30-60 seconds</p>
      <div class="loading-steps text-start" style="max-width: 300px; margin: 0 auto;">
        <div class="loading-step active" id="step1"><span class="icon">ğŸ—ºï¸</span> Researching destination...</div>
        <div class="loading-step" id="step2"><span class="icon">ğŸš„</span> Finding transport...</div>
        <div class="loading-step" id="step3"><span class="icon">ğŸ¨</span> Searching hotels...</div>
        <div class="loading-step" id="step4"><span class="icon">ğŸ¯</span> Planning activities...</div>
        <div class="loading-step" id="step5"><span class="icon">ğŸ½ï¸</span> Finding restaurants...</div>
        <div class="loading-step" id="step6"><span class="icon">ğŸ“‹</span> Checking requirements...</div>
        <div class="loading-step" id="step7"><span class="icon">ğŸš¨</span> Adding safety info...</div>
        <div class="loading-step" id="step8"><span class="icon">ğŸ“¦</span> Building package...</div>
      </div>
    </div>
  `;
  
  // Animate loading steps
  const steps = ['step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8'];
  let currentStep = 0;
  const stepInterval = setInterval(() => {
    if (currentStep > 0) {
      document.getElementById(steps[currentStep - 1]).classList.remove('active');
      document.getElementById(steps[currentStep - 1]).classList.add('done');
      document.getElementById(steps[currentStep - 1]).querySelector('.icon').textContent = 'âœ…';
    }
    if (currentStep < steps.length) {
      document.getElementById(steps[currentStep]).classList.add('active');
      currentStep++;
    } else {
      clearInterval(stepInterval);
    }
  }, 3000);
  
  try {
    const response = await fetch('/api/travel/plan', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: document.getElementById('query').value,
        source: document.getElementById('source').value,
        destination: document.getElementById('destination').value,
        preferences: {
          food_preference: document.getElementById('food_preference').value,
          budget: document.getElementById('budget').value
        }
      })
    });
    
    clearInterval(stepInterval);
    const data = await response.json();
    
    if (data.error) {
      statusBadge.className = 'badge bg-danger';
      statusBadge.textContent = 'Error';
      resultDiv.innerHTML = `
        <div class="alert alert-danger m-3">
          <h5>âŒ Error</h5>
          <p>${data.error}</p>
          <small>Make sure FastAPI server is running on port 8000</small>
        </div>
      `;
    } else {
      statusBadge.className = 'badge bg-success';
      statusBadge.textContent = 'Complete';
      
      let content = data.final_package || JSON.stringify(data, null, 2);
      
      // Format the result nicely
      resultDiv.innerHTML = `
        <div class="result-section">
          <h5>ğŸ‰ Your Itinerary is Ready!</h5>
          <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${content}</pre>
        </div>
      `;
    }
  } catch (error) {
    clearInterval(stepInterval);
    statusBadge.className = 'badge bg-danger';
    statusBadge.textContent = 'Error';
    resultDiv.innerHTML = `
      <div class="alert alert-danger m-3">
        <h5>âŒ Connection Error</h5>
        <p>${error.message}</p>
        <small>Make sure FastAPI server is running on port 8000</small>
        <hr>
        <p class="mb-0"><strong>To start FastAPI:</strong></p>
        <code>cd "AI Compare" && python3 main.py</code>
      </div>
    `;
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'ğŸš€ Generate Itinerary';
  }
});
</script>
